version: '3.8'

services:
  # TTS è¨“ç·´å°ˆç”¨æœå‹™
  tts_training:
    build:
      context: ./backend/tts
      dockerfile: Dockerfile
    container_name: podwise_tts_training
    ports:
      - "7860:7860" # GPT-SoVITS WebUI (æ¨ç†)
      - "7861:7861" # GPT-SoVITS WebUI (è¨“ç·´)
      - "8002:8002" # Streamlit ç®¡ç†ä»‹é¢
      - "8003:8003" # TTS API æœå‹™
      - "9880:9880" # GPT-SoVITS API
    environment:
      - DEBUG=true
      - DEFAULT_VOICE=podri
      - GRADIO_SERVER_PORT=7860
      - GRADIO_SERVER_NAME=0.0.0.0
      - STREAMLIT_SERVER_PORT=8002
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - API_SERVER_PORT=8003
      - WEBUI_TRAINING_PORT=7861
    volumes:
      - ./backend/tts/GPT-SoVITS:/app/GPT-SoVITS
      - ./backend/tts/models:/app/models
      - ./backend/tts/training_data:/app/training_data
      - ./backend/tts/raw:/app/raw
      - ./backend/tts/logs:/app/logs
      - ./backend/tts/output:/app/output
      - ./backend/tts/cache:/app/cache
      - ./backend/tts/pretrained_models:/app/pretrained_models
    command: >
      bash -c "
        echo 'ğŸš€ å•Ÿå‹• TTS è¨“ç·´ç’°å¢ƒ...' &&
        cd /app/GPT-SoVITS &&
        echo 'ğŸ“Š å•Ÿå‹• GPT-SoVITS WebUI (æ¨ç†)...' &&
        python webui.py --port 7860 --host 0.0.0.0 &
        echo 'ğŸ“ å•Ÿå‹• GPT-SoVITS WebUI (è¨“ç·´)...' &&
        python webui.py --port 7861 --host 0.0.0.0 &
        echo 'ğŸ”§ å•Ÿå‹• TTS API æœå‹™...' &&
        cd /app && python api.py &
        echo 'ğŸ“Š å•Ÿå‹• Streamlit ç®¡ç†ä»‹é¢...' &&
        python -m streamlit run app/streamlit_app.py --server.port 8002 --server.address 0.0.0.0 &
        echo 'â³ ç­‰å¾…æœå‹™å•Ÿå‹•...' &&
        sleep 10 &&
        echo 'ğŸ“Š TTS è¨“ç·´ç’°å¢ƒç‹€æ…‹ï¼š' &&
        echo '   - æ¨ç† WebUI: http://localhost:7860' &&
        echo '   - è¨“ç·´ WebUI: http://localhost:7861' &&
        echo '   - ç®¡ç†ä»‹é¢: http://localhost:8002' &&
        echo '   - API æœå‹™: http://localhost:8003' &&
        echo '   - GPT-SoVITS API: http://localhost:9880' &&
        echo 'âœ… TTS è¨“ç·´ç’°å¢ƒå•Ÿå‹•å®Œæˆï¼' &&
        tail -f /dev/null
      "
    networks:
      - tts_training
    restart: unless-stopped

  # å¯é¸ï¼šPostgreSQL è³‡æ–™åº«ï¼ˆç”¨æ–¼å„²å­˜è¨“ç·´è¨˜éŒ„ï¼‰
  postgres_training:
    image: postgres:15
    container_name: podwise_postgres_training
    environment:
      POSTGRES_DB: tts_training
      POSTGRES_USER: tts_user
      POSTGRES_PASSWORD: tts_password
    ports:
      - "5433:5432"
    volumes:
      - postgres_training_data:/var/lib/postgresql/data
    networks:
      - tts_training
    restart: unless-stopped

networks:
  tts_training:
    driver: bridge

volumes:
  postgres_training_data:
