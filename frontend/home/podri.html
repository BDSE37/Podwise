<!DOCTYPE html>
<html lang="zh-Hant">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podri</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

</head>

<body>

    <section class="vh-100" style="background-color: #eee;">
        <div class="container-fluid py-5 h-100">
            <div class="row d-flex justify-content-center align-items-start h-100">
                <!-- Sidebar（固定在左側） -->
                <button id="sidebar-expand" style="display:none; position:fixed; top:30px; left:30px; z-index:1100;" class="btn btn-outline-secondary">&#9776;</button>
                <div id="sidebar">
                    <!-- 漢堡按鈕 -->
                    <button class="btn btn-outline-secondary sidebar-hamburger" id="sidebar-toggle" style="position:absolute; top:10px; left:10px;">
                        &#9776;
                    </button>
                    <!-- 用戶頭像與名稱 -->
                    <div class="text-center mb-3 mt-4">
                        <img src="images/user.png" class="rounded-circle user-avatar" alt="User">
                        <p class="mt-2 mb-0 user-name">User</p>
                    </div>
                    
                    <!-- 聲音模型 -->
                    <div class="voice-model-section">
                        <div class="section-title-row">
                            <div class="section-title">聲音模型</div>
                            <!-- TTS 開關 -->
                            <div class="toggle-button-cover">
                                <div id="button-3" class="button r">
                                    <input class="checkbox" type="checkbox" id="tts-toggle" checked>
                                    <div class="knobs"></div>
                                    <div class="layer"></div>
                                </div>
                            </div>
                        </div>
                        <div class="voice-model-list">
                            <div class="voice-model-card selected" data-model="podrina">
                                <img src="images/podcasts_purple.png" class="voice-icon" alt="Podrina">
                                <span class="voice-name">Podrina</span>
                                <span class="voice-desc">（溫柔女聲）</span>
                            </div>
                            <div class="voice-model-card" data-model="podrisa">
                                <img src="images/podcasts_pink.png" class="voice-icon" alt="Podrisa">
                                <span class="voice-name">Podrisa</span>
                                <span class="voice-desc">（活潑女聲）</span>
                            </div>
                            <div class="voice-model-card" data-model="podrino">
                                <img src="images/podcasts_golden.png" class="voice-icon" alt="Podrino">
                                <span class="voice-name">Podrino</span>
                                <span class="voice-desc">（穩重男聲）</span>
                            </div>

                        </div>
                    </div>
                    <!-- 技能進度條區塊 -->
                    <div class="skill-container">
                        <div class="skill-box">
                            <span class="title">聲音語速</span>
                            <div class="skill-bar">
                                <span class="skill-per html" id="html-bar">
                                    <select id="html-select" class="bar-select">
                                        <option value="0.5">0.5</option>
                                        <option value="0.75">0.75</option>
                                        <option value="1" selected>正常</option>
                                        <option value="1.25">1.25</option>
                                        <option value="1.5">1.5</option>
                                    </select>
                                </span>
                            </div>
                        </div>
                    </div>
                    <!-- 歷史對話 -->
                    <div class="history-section">
                        <div class="section-title">歷史對話</div>
                        <div class="history-list">
                            <div class="history-card">2024/06/01 聊天紀錄</div>
                            <div class="history-card">2024/05/30 聊天紀錄</div>
                            <div class="history-card">2024/05/28 聊天紀錄</div>
                        </div>
                    </div>
                </div>
                <!-- 主內容區域 -->
                <div class="col-lg-9 col-md-8" id="main-content">
                    <div class="card" id="chat1" style="border-radius: 15px;">
                        <div class="card-header position-relative bg-dark text-white border-bottom-0 text-center"
                            style="border-top-left-radius: 15px; border-top-right-radius: 15px; padding: 1rem;">
                            <p class="mb-0 fw-bold" style="margin: 0;">Podri 為你精準調頻，打造你的個人聲音空間！</p>
                            <a href="index.html" style="position: absolute; top: 10px; right: 15px;">
                                <img src="images/home.png" alt="關閉"
                                    style="width: 30px; height: 30px; cursor: pointer;">
                            </a>
                        </div>
                        <div class="card-body" id="chat-messages">
                            <div class="d-flex flex-row justify-content-start mb-4">
                                <img src="images/logo_black.png" class="rounded-circle" style="width: 55px; height: 100%;">
                                <div class="p-3 ms-3" style="border-radius: 15px; background-color: #efeeef;">
                                    <p class="small mb-0">Hi 我是Podri<br>今天想聽什麼主題？</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-muted d-flex justify-content-start align-items-center p-3">
                            <input type="text" class="form-control form-control-lg" id="exampleFormControlInput1"
                                placeholder="開始跟 Podri 對話...">
                            <a class="ms-3" href="javascript:void(0);" id="show-action-wrap"><img src="images/podcasts_green.png" alt="發送"
                                    style="width: 55px; height: 55px; cursor: pointer;"></a>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </section>

    <!-- action-wrap 彈窗 -->
    <div id="action-wrap" style="display: none;">
        <div class="action" id="stt-action">
            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            </svg>
        </div>
        <div class="action" id="send-action">
            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
        </div>
        <div class="action" id="voice-action">
            <svg class="action-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
            </svg>
        </div>
        <div class="backdrop"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./migrate_localStorage.js"></script>
    
    <script>
        // 全域變數
        let currentUserMessage = '';
        let currentPodriResponse = '';
        let isProcessing = false;
        let currentAudio = null;
        
        // STT 相關變數
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        // 頁面載入時檢查 URL 參數並填入對話框
        window.addEventListener('DOMContentLoaded', function() {
            // 檢查用戶認證 - 確保只有通過首頁認證的用戶才能訪問
            const urlParams = new URLSearchParams(window.location.search);
            let userId = urlParams.get('user_id');
            
            // 如果 URL 中沒有 user_id，嘗試從 localStorage 獲取
            if (!userId) {
                userId = localStorage.getItem('currentUserId');
            }
            
            if (!userId) {
                // 如果沒有 user_id，重定向回首頁
                alert('請先從首頁登入 Podwise');
                window.location.href = 'index.html';
                return;
            }
            
            // 設置當前用戶ID
            window.currentUserId = userId;
            
            // 確保 TTS 開關預設為開啟
            const ttsToggle = document.getElementById('tts-toggle');
            if (ttsToggle) {
                ttsToggle.checked = true;
                // 觸發 change 事件以更新視覺狀態
                ttsToggle.dispatchEvent(new Event('change'));
                // 強制更新 CSS 樣式
                setTimeout(() => {
                    ttsToggle.dispatchEvent(new Event('change'));
                }, 100);
                console.log('TTS 開關已設定為開啟狀態');
            }
            
            // 確保 Podrina 預設選中
            const podrinaCard = document.querySelector('.voice-model-card[data-model="podrina"]');
            if (podrinaCard) {
                // 移除其他選中狀態
                document.querySelectorAll('.voice-model-card').forEach(card => {
                    card.classList.remove('selected');
                });
                // 選中 Podrina
                podrinaCard.classList.add('selected');
                console.log('Podrina 已預設選中');
            }
            
            // 添加語音切換事件監聽器
            document.querySelectorAll('.voice-model-card').forEach(card => {
                card.addEventListener('click', function() {
                    // 移除所有選中狀態
                    document.querySelectorAll('.voice-model-card').forEach(c => {
                        c.classList.remove('selected');
                    });
                    // 添加選中狀態到當前卡片
                    this.classList.add('selected');
                    
                    const selectedVoice = this.dataset.model;
                    console.log('切換語音到:', selectedVoice);
                    
                    // 可以添加視覺反饋
                    const voiceName = this.querySelector('.voice-name').textContent;
                    showToast(`已切換到 ${voiceName} 語音`);
                });
            });
            
            // URL 參數填入對話框
            const searchText = urlParams.get('search');
            if (searchText) {
                const chatInput = document.getElementById('exampleFormControlInput1');
                if (chatInput) {
                    chatInput.value = decodeURIComponent(searchText);
                    chatInput.focus();
                    // 自動發送查詢
                    setTimeout(() => {
                        sendMessage();
                    }, 500);
                }
            }

            // sidebar 收起/展開功能
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const expandBtn = document.getElementById('sidebar-expand');
            if(toggleBtn && sidebar && mainContent && expandBtn) {
                toggleBtn.onclick = function() {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('expanded');
                    expandBtn.style.display = 'block';
                };
                expandBtn.onclick = function() {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('expanded');
                    expandBtn.style.display = 'none';
                };
            }

            // action-wrap 彈窗顯示/隱藏
            document.getElementById('show-action-wrap').onclick = function(e) {
              e.preventDefault();
              e.stopPropagation();
              document.getElementById('action-wrap').style.display = 'flex';
            };
            document.querySelector('#action-wrap .backdrop').onclick = function() {
              document.getElementById('action-wrap').style.display = 'none';
            };

            // 語音模型單選高亮
            document.querySelectorAll('.voice-model-card').forEach(function(card) {
                card.onclick = function() {
                    document.querySelectorAll('.voice-model-card').forEach(function(c) {
                        c.classList.remove('selected');
                    });
                    this.classList.add('selected');
                };
            });

            // HTML 技能進度條選單變化時更新寬度
            document.getElementById('html-select').addEventListener('change', function() {
                let val = parseFloat(this.value);
                let percent = Math.min(val, 1) * 100; // 超過100%時只顯示滿格
                document.getElementById('html-bar').style.width = percent + '%';
            });

            // 輸入框 Enter 鍵發送
            document.getElementById('exampleFormControlInput1').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !isProcessing) {
                    sendMessage();
                }
            });

            // 發送按鈕點擊 - 移除重複的事件監聽器
            // document.getElementById('show-action-wrap').addEventListener('click', function() {
            //     if (!isProcessing) {
            //         sendMessage();
            //     }
            // });

            // action-wrap 按鈕事件
            document.getElementById('stt-action').addEventListener('click', function() {
                if (!isRecording) {
                    startSTTRecording();
                } else {
                    stopSTTRecording();
                }
                document.getElementById('action-wrap').style.display = 'none';
            });

            document.getElementById('send-action').addEventListener('click', function() {
                if (!isProcessing) {
                    sendMessage();
                }
                document.getElementById('action-wrap').style.display = 'none';
            });

            document.getElementById('voice-action').addEventListener('click', function() {
                // 語音設定功能（可以擴展）
                alert('語音設定功能開發中...');
                document.getElementById('action-wrap').style.display = 'none';
            });
        });

        // 發送訊息到 RAG Pipeline
        async function sendMessage() {
            const input = document.getElementById('exampleFormControlInput1');
            const message = input.value.trim();
            
            if (!message || isProcessing) {
                return;
            }

            isProcessing = true;
            currentUserMessage = message;

            // 添加用戶訊息到聊天界面
            addUserMessage(message);
            input.value = '';

            // 顯示載入狀態
            addLoadingMessage();

            try {
                // 獲取 TTS 設定
                const ttsEnabled = document.getElementById('tts-toggle').checked;
                const selectedVoiceCard = document.querySelector('.voice-model-card.selected');
                const selectedVoice = selectedVoiceCard ? selectedVoiceCard.dataset.model : 'podrina';
                const speed = document.getElementById('html-select').value;

                console.log('TTS 設定:', { ttsEnabled, selectedVoice, speed });

                // 發送到 RAG Pipeline API 服務 (通過 FastAPI 代理)
                const response = await fetch('/api/rag/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: message,
                        user_id: window.currentUserId || 'Podwise0001', // 使用 Podwise ID 格式
                        session_id: `session_${window.currentUserId}_${Date.now()}`,
                        enable_tts: true, // 強制開啟 TTS
                        voice: selectedVoice,
                        speed: parseFloat(speed),
                        metadata: {
                            source: 'podri_chat',
                            timestamp: new Date().toISOString()
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('RAG Pipeline 回應:', data);
                
                // 移除載入訊息並添加 Podri 回覆
                removeLoadingMessage();
                
                if (data.response) {
                    currentPodriResponse = data.response;
                    addPodriMessage(data.response);

                    // 如果 TTS 開啟，自動播放語音
                    if (ttsEnabled) {
                        console.log('TTS 已啟用，準備播放語音...');
                        
                        if (data.audio_data) {
                            console.log('使用 RAG Pipeline 返回的音頻數據');
                            playTTSAudio(data.audio_data);
                        } else {
                            console.log('RAG Pipeline 沒有返回音頻，單獨呼叫 TTS 服務');
                            // 如果 TTS 開啟但沒有音頻數據，單獨呼叫 TTS 服務
                            await generateTTS(data.response, selectedVoice, speed);
                        }
                    } else {
                        console.log('TTS 已禁用');
                    }
                } else {
                    throw new Error(data.error || '查詢失敗');
                }

            } catch (error) {
                console.error('發送訊息失敗:', error);
                removeLoadingMessage();
                addPodriMessage('抱歉，我遇到了一些問題，請稍後再試。', true);
            } finally {
                isProcessing = false;
            }
        }

        // 生成 TTS 語音
        async function generateTTS(text, voice, speed) {
            try {
                console.log('開始生成 TTS:', { text: text.substring(0, 50) + '...', voice, speed });
                
                // 計算語速調整
                const rateAdjustment = calculateRateAdjustment(speed);
                
                const response = await fetch('/api/tts/synthesize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        文字: text,
                        語音: voice,
                        語速: rateAdjustment
                    })
                });

                if (!response.ok) {
                    throw new Error(`TTS HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('TTS 服務回應:', data);
                
                if (data.成功 && data.音訊檔案) {
                    console.log('TTS 生成成功，開始播放');
                    // 播放語音
                    playTTSAudio(data.音訊檔案);
                } else {
                    console.warn('TTS 生成失敗:', data.錯誤訊息 || '未知錯誤');
                }

            } catch (error) {
                console.error('TTS 生成失敗:', error);
            }
        }

        // 計算語速調整
        function calculateRateAdjustment(speed) {
            const speedValue = parseFloat(speed);
            if (speedValue === 1) return "+0%";
            if (speedValue < 1) {
                const reduction = Math.round((1 - speedValue) * 100);
                return `-${reduction}%`;
            } else {
                const increase = Math.round((speedValue - 1) * 100);
                return `+${increase}%`;
            }
        }



        // 顯示提示訊息
        function showToast(message, duration = 2000) {
            // 創建 toast 元素
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #333;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transition: opacity 0.3s ease;
            `;
            toast.textContent = message;
            
            // 添加到頁面
            document.body.appendChild(toast);
            
            // 自動移除
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // 播放 TTS 語音
        function playTTSAudio(base64Audio) {
            try {
                // 停止當前播放的音頻
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }

                // 創建新的音頻元素
                currentAudio = new Audio();
                currentAudio.src = `data:audio/wav;base64,${base64Audio}`;
                
                currentAudio.addEventListener('loadstart', () => {
                    console.log('開始載入 TTS 音頻...');
                });
                
                currentAudio.addEventListener('canplay', () => {
                    console.log('TTS 音頻可以播放');
                });
                
                currentAudio.addEventListener('play', () => {
                    console.log('開始播放 TTS 音頻');
                });
                
                currentAudio.addEventListener('ended', () => {
                    console.log('TTS 音頻播放結束');
                    currentAudio = null;
                });
                
                currentAudio.addEventListener('error', (e) => {
                    console.error('TTS 音頻播放錯誤:', e);
                    currentAudio = null;
                });

                // 開始播放
                currentAudio.play().catch(error => {
                    console.error('TTS 音頻播放失敗:', error);
                });

            } catch (error) {
                console.error('播放 TTS 音頻失敗:', error);
            }
        }

        // 添加用戶訊息
        function addUserMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'd-flex flex-row justify-content-end mb-4';
            messageDiv.innerHTML = `
                <div class="p-3 me-3 border" style="border-radius: 15px; background-color: #fbfbfb;">
                    <p class="small mb-0">${escapeHtml(message)}</p>
                </div>
                <img src="images/user.png" class="rounded-circle" style="width: 55px; height: 55px;">
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // 添加 Podri 訊息
        function addPodriMessage(message, isError = false) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'd-flex flex-row justify-content-start mb-4';
            
            const bgColor = isError ? '#ffe6e6' : '#efeeef';
            const textColor = isError ? '#d32f2f' : '#000';
            
            messageDiv.innerHTML = `
                <img src="images/logo_black.png" class="rounded-circle" style="width: 55px; height: 100%;">
                <div class="p-3 ms-3" style="border-radius: 15px; background-color: ${bgColor};">
                    <p class="small mb-0" style="color: ${textColor};">${escapeHtml(message)}</p>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // 添加載入訊息
        function addLoadingMessage() {
            const chatMessages = document.getElementById('chat-messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.className = 'd-flex flex-row justify-content-start mb-4';
            loadingDiv.innerHTML = `
                <img src="images/logo_black.png" class="rounded-circle" style="width: 55px; height: 100%;">
                <div class="p-3 ms-3" style="border-radius: 15px; background-color: #efeeef;">
                    <p class="small mb-0">
                        <span class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </span>
                    </p>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            scrollToBottom();
        }

        // 移除載入訊息
        function removeLoadingMessage() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        // 滾動到底部
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 生成會話 ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // HTML 轉義
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== STT 語音識別功能 ====================

        // 開始錄音
        async function startSTTRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = function(event) {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    processSTTAudio(audioBlob);
                    
                    // 停止麥克風
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // 更新 UI
                document.getElementById('stt-action').classList.add('recording');
                document.getElementById('stt-action').innerHTML = '<svg class="action-icon" viewBox="0 0 24 24" fill="currentColor" style="color: white;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
                
                console.log('開始錄音...');
                
            } catch (error) {
                console.error('無法啟動麥克風:', error);
                alert('無法啟動麥克風，請檢查權限設定。');
            }
        }

        // 停止錄音
        function stopSTTRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // 更新 UI
                document.getElementById('stt-action').classList.remove('recording');
                document.getElementById('stt-action').innerHTML = '<svg class="action-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>';
                
                console.log('停止錄音...');
            }
        }

        // 處理 STT 音頻
        async function processSTTAudio(audioBlob) {
            try {
                // 顯示載入狀態
                const input = document.getElementById('exampleFormControlInput1');
                input.value = '正在識別語音...';
                input.disabled = true;
                
                // 準備 FormData
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.wav');
                formData.append('language', 'zh');
                
                // 發送到 STT 服務
                const response = await fetch('http://localhost:8001/transcribe', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`STT 服務錯誤: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.text && result.text.trim()) {
                    // 將識別結果填入輸入框
                    input.value = result.text.trim();
                    input.disabled = false;
                    
                    console.log('語音識別成功:', result.text);
                    
                    // 自動發送訊息
                    setTimeout(() => {
                        sendMessage();
                    }, 500);
                    
                } else {
                    input.value = '';
                    input.disabled = false;
                    alert('無法識別語音內容，請重試。');
                }
                
            } catch (error) {
                console.error('STT 處理失敗:', error);
                const input = document.getElementById('exampleFormControlInput1');
                input.value = '';
                input.disabled = false;
                alert('語音識別失敗，請重試。');
            }
        }
    </script>
    <style>
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 300px;
            height: 100vh;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.10);
            padding: 2rem 1.2rem 1.2rem 1.2rem;
            min-width: 270px;
            max-width: 320px;
            margin: 0 auto;
            z-index: 1050;
            transition: all 0.3s;
        }
        #sidebar.collapsed {
            display: none;
        }
        #main-content {
            margin-left: 320px; /* sidebar寬度+間距 */
            transition: margin-left 0.3s;
        }
        #main-content.expanded {
            margin-left: 0;
        }
        .sidebar-hamburger {
            font-size: 1.5rem;
            padding: 0.25rem 0.75rem;
        }
        #sidebar-expand {
            position: fixed;
            top: 30px;
            left: 30px;
            z-index: 1100;
            width: 48px;
            height: 48px;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: none;
            align-items: center;
            justify-content: center;
        }
        @media (max-width: 991px) {
            #sidebar {
                width: 220px;
                padding-top: 1rem;
            }
            #main-content {
                margin-left: 0;
            }
        }
        #action-wrap {
          position: fixed;
          top: 50%; left: 50%;
          transform: translate(-50%, -50%);
          z-index: 2000;
          background: #fff;
          border-radius: 1em;
          box-shadow: 0 8px 32px rgba(0,0,0,0.18);
          padding: 2em 2.5em 1.5em 2.5em;
          display: flex;
          flex-direction: row;
          gap: 1.5em;
          align-items: center;
        }
        #action-wrap .action {
          background: #f6f6fa;
          border: none;
          border-radius: 50%;
          width: 56px; height: 56px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          cursor: pointer;
          transition: background 0.2s;
        }
        #action-wrap .action:hover {
          background: #e0e0f7;
        }
        #action-wrap .action-icon {
          width: 32px; height: 32px;
          color: #7c4dff;
        }
        #action-wrap .action-content {
          display: none;
        }
        #action-wrap .backdrop {
          position: fixed;
          top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0,0,0,0.25);
          z-index: -1;
        }
        .user-avatar {
            width: 80px;
            height: 80px;
            margin-bottom: 0.5rem;
        }
        .user-name {
            font-size: 1.1rem;
            font-weight: 500;
            color: #444;
        }
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #222;
        }
        .voice-model-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .voice-model-card {
            display: flex;
            align-items: center;
            background: #fafaff;
            border: 1.5px solid #ececec;
            border-radius: 12px;
            padding: 0.5rem 0.8rem;
            gap: 0.5rem;
            font-size: 0.98rem;
            box-shadow: 0 1px 4px rgba(127,85,255,0.06);
            cursor: pointer;
            transition: border 0.2s, box-shadow 0.2s, background 0.2s;
        }
        .voice-model-card.selected {
            border: 2px solid #7c4dff;
            background: #f3e8ff;
            box-shadow: 0 2px 8px rgba(127,85,255,0.12);
        }
        .voice-icon {
            width: 28px; height: 28px; display: inline-block;
            background-size: contain; background-repeat: no-repeat;
        }
        .voice-name { font-weight: 600; margin-right: 2px; }
        .voice-desc { color: #888; font-size: 0.95em; }
        .history-section { margin-top: 0.5rem; }
        .history-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .history-card {
            background: #fafaff;
            border: 1.5px solid #ececec;
            border-radius: 10px;
            padding: 0.5rem 0.8rem;
            font-size: 0.98rem;
            color: #444;
            box-shadow: 0 1px 4px rgba(127,85,255,0.06);
        }
        .section-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            margin-top: 1.2rem;
            width: 100%;
            gap: 1rem;
        }
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #222;
            white-space: nowrap;   /* 不換行 */
            flex-shrink: 0;
        }
        .toggle-button-cover {
            min-width: 80px;
            max-width: 110px;
            width: 100px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        /* From Uiverse.io by JaydipPrajapati1910 */ 
        .toggle-button-cover {
            display: table-cell;
            position: relative;
            width: 200px;
            height: 140px;
            box-sizing: border-box;
        }

        .button-cover {
            height: 100px;
            margin: 20px;
            background-color: #fff;
            box-shadow: 0 10px 20px -8px #c5d6d6;
            border-radius: 4px;
        }

        .button-cover:before {
            counter-increment: button-counter;
            content: counter(button-counter);
            position: absolute;
            right: 0;
            bottom: 0;
            color: #d7e3e3;
            font-size: 12px;
            line-height: 1;
            padding: 5px;
        }

        .button-cover,
        .knobs,
        .layer {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }

        .button {
            position: relative;
            top: 50%;
            width: 74px;
            height: 36px;
            margin: -20px auto 0 auto;
            overflow: hidden;
        }

        .checkbox {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            opacity: 0;
            cursor: pointer;
            z-index: 3;
        }

        .knobs {
            z-index: 2;
        }

        .layer {
            width: 100%;
            background-color: #ebf7fc;
            transition: 0.3s ease all;
            z-index: 1;
        }

        .button.r,
        .button.r .layer {
            border-radius: 100px;
        }

        #button-3 .knobs:before {
            content: "YES";
            position: absolute;
            top: 2px;
            left: 2px;
            width: 32px;
            height: 32px;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            line-height: 32px;
            background-color: #03a9f4;
            border-radius: 50%;
            transition: 0.3s ease all, left 0.3s cubic-bezier(0.18, 0.89, 0.35, 1.15);
            box-sizing: border-box;
            padding: 0;
        }

        #button-3 .checkbox:active + .knobs:before {
            width: 46px;
            border-radius: 100px;
        }

        #button-3 .checkbox:checked:active + .knobs:before {
            margin-left: -26px;
        }

        #button-3 .checkbox:checked + .knobs:before {
            content: "NO";
            left: 40px; /* 根據 .button 寬度微調 */
            background-color: #f44336;
        }

        #button-3 .checkbox:checked ~ .layer {
            background-color: #fcebeb;
        }

        /* 確保 TTS 開關預設為開啟狀態 */
        #tts-toggle:not(:checked) + .knobs:before {
            content: "YES";
            left: 2px;
            background-color: #03a9f4;
        }

        #tts-toggle:not(:checked) ~ .layer {
            background-color: #ebf7fc;
        }
        .skill-container {
            margin: 1.2rem 0 1.2rem 0;
        }
        .skill-box {
            width: 100%;
        }
        .skill-box .title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #222;
        }
        .skill-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 8px;
            margin-top: 2px;       /* 讓bar更靠近按鈕 */
            position: relative;
        }
        .skill-per {
            display: block;
            height: 100%;
            border-radius: 8px;
            position: relative;
            background: #7c4dff;
            transition: width 0.3s;
        }
        .bar-select {
            position: absolute;
            top: -32px;
            right: 0;
            font-size: 0.9rem;
            border-radius: 4px;
            padding: 2px 8px;
            background: #7c4dff;
            color: #fff;
            border: none;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }
        .speed-btn-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0;      /* 讓按鈕組緊貼bar */
        }
        .section-title-hot {
            margin-top: 2rem;
        }

        /* 打字指示器樣式 */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #999;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* 聊天區域滾動樣式 */
        #chat-messages {
            max-height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        #chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        #chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* action-wrap 按鈕樣式 */
        #stt-action.recording {
            background-color: #dc3545 !important;
            animation: pulse 1s infinite;
        }

        #stt-action.recording .action-icon {
            color: white !important;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* 語音切換樣式 */
        .voice-model-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .voice-model-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .voice-model-card.selected {
            border-color: #7c4dff;
            background-color: rgba(124, 77, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 77, 255, 0.3);
        }
        
        .voice-model-card.selected .voice-name {
            color: #7c4dff;
            font-weight: 600;
        }
        
        /* 語音切換動畫 */
        .voice-model-card {
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</body>
</html>